{% extends "base.html" %}
{% block content %}

<div style="
    min-height: calc(100vh - 110px);
    display:flex;
    align-items:center;
    justify-content:center;
    padding:20px;
">

  <div style="
      width:100%;
      max-width:520px;
      background:white;
      border-radius:18px;
      padding:18px;
      box-shadow:0 8px 24px rgba(15,23,42,0.10);
      border:1px solid #eef2f7;
  ">

    <h2 style="
        margin:0;
        text-align:center;
        font-size:22px;
        font-weight:900;
        color:#111827;
    ">
      ðŸ’³ Wallet Top-up Payment
    </h2>

    <p style="
        margin:8px 0 0;
        text-align:center;
        color:#6b7280;
        font-weight:700;
        font-size:13px;
    ">
      Complete your payment securely using Razorpay
    </p>

    <hr style="border:none; height:1px; background:#e5e7eb; margin:14px 0;">

    <!-- Amount Box -->
    <div style="
        background:#eff6ff;
        border:1px solid #bfdbfe;
        padding:14px;
        border-radius:16px;
        text-align:center;
        margin-bottom:14px;
    ">
      <p style="margin:0; font-weight:800; color:#1d4ed8;">
        Amount to Add
      </p>

      <h1 style="
          margin:10px 0 0;
          font-size:38px;
          font-weight:900;
          color:#111827;
      ">
        â‚¹{{ payment.amount }}
      </h1>

      <p style="margin:8px 0 0; font-size:12px; color:#6b7280; font-weight:700;">
        Order ID: <span style="color:#111827; font-weight:900;">{{ payment.razorpay_order_id }}</span>
      </p>
    </div>

    <!-- Pay Button -->
    <button id="rzp-button1" style="
        width:100%;
        background:#2563eb;
        color:white;
        padding:12px 16px;
        border-radius:14px;
        font-weight:900;
        border:none;
        cursor:pointer;
        font-size:15px;
    ">
      Pay Now
    </button>

    <!-- Back -->
    <a href="/wallet/" style="
        margin-top:10px;
        width:100%;
        background:#111827;
        color:white;
        padding:12px 16px;
        border-radius:14px;
        font-weight:900;
        text-decoration:none;
        display:inline-flex;
        align-items:center;
        justify-content:center;
        box-sizing:border-box;
    ">
      Back to Wallet
    </a>

    <p style="
        margin:12px 0 0;
        text-align:center;
        font-size:12px;
        color:#6b7280;
        font-weight:700;
    ">
      ðŸ”’ Powered by Razorpay â€¢ Safe & Secure
    </p>

  </div>
</div>

<script src="https://checkout.razorpay.com/v1/checkout.js"></script>

<script>
  // âœ… Read CSRF token from Django cookie (WORKING METHOD)
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== "") {
      const cookies = document.cookie.split(";");
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + "=")) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }

  const csrfToken = getCookie("csrftoken");

  var options = {
    "key": "{{ razorpay_key }}",
    "amount": "{{ payment.amount }}00",
    "currency": "INR",
    "name": "T-tac",
    "description": "Wallet Top-up",
    "order_id": "{{ payment.razorpay_order_id }}",

    "handler": function (response) {

      var form = document.createElement("form");
      form.method = "POST";
      form.action = "{% url 'wallet_verify_payment' payment.id %}";

      // âœ… Correct CSRF token
      var csrf = document.createElement("input");
      csrf.type = "hidden";
      csrf.name = "csrfmiddlewaretoken";
      csrf.value = csrfToken;
      form.appendChild(csrf);

      // âœ… Razorpay fields
      var payId = document.createElement("input");
      payId.type = "hidden";
      payId.name = "razorpay_payment_id";
      payId.value = response.razorpay_payment_id;
      form.appendChild(payId);

      var orderId = document.createElement("input");
      orderId.type = "hidden";
      orderId.name = "razorpay_order_id";
      orderId.value = response.razorpay_order_id;
      form.appendChild(orderId);

      var sig = document.createElement("input");
      sig.type = "hidden";
      sig.name = "razorpay_signature";
      sig.value = response.razorpay_signature;
      form.appendChild(sig);

      document.body.appendChild(form);
      form.submit();
    },

    "theme": { "color": "#2563eb" }
  };

  var rzp1 = new Razorpay(options);
  document.getElementById("rzp-button1").onclick = function(e){
    rzp1.open();
    e.preventDefault();
  }
</script>

{% endblock %}
